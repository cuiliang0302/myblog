{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é‡ç½®å¯†ç </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?5abb8d046dd1dd0d2ff4094f445b3079";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
<div class="box">
    <section class="inner">
        <div class="form-edge">
            <h4>é‡ç½®å¯†ç </h4>
            <div class="step">
                <div class="step-list finish-list"></div>
                <div class="step-list"></div>
                <div class="step-list"></div>
                <div class="text-box">
                    <div class="step-text finish-text">
                        <em>1</em>
                        <br>
                        <strong>èº«ä»½éªŒè¯</strong>
                    </div>
                    <div class="step-text">
                        <em>2</em>
                        <br>
                        <strong>è®¾ç½®æ–°å¯†ç </strong>
                    </div>
                    <div class="step-text">
                        <em>3</em>
                        <br>
                        <strong>é‡ç½®å®Œæˆ</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-body">
            <form class="form-show layui-form">
                <div class="form-group">
                    {{ forget_form.email }}
                    <i class="input-icon layui-icon layui-icon-email"></i>
                    <button type="button" class="layui-btn layui-btn-primary" id="send_btn">è·å–éªŒè¯ç </button>
                </div>
                <div class="form-group verification">
                    {{ forget_form.email_code }}
                    <i class="input-icon layui-icon layui-icon-vercode"></i>
                </div>
                <div class="form-button button-show">
                    <button type="button" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="email"
                            id="email_next">ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </form>
            <form class="layui-form">
                <div class="form-group">
                    {{ forget_form.password1 }}
                    <i class="input-icon layui-icon layui-icon-password"></i>
                </div>
                <div class="form-group verification">
                    {{ forget_form.password2 }}
                    <i class="input-icon layui-icon layui-icon-password"></i>
                </div>
                <div class="form-button">
                    <button type="button" class="layui-btn layui-btn-warm">ä¸Šä¸€æ­¥</button>
                    <button type="button" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="password"
                            id="password_next">ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </form>
            <form class="layui-form">
                <h1>ğŸ˜€ å¯†ç é‡ç½®æˆåŠŸï¼Œå¿«å»ç™»å½•å§ï¼</h1>
                <div class="form-button">
                    <button type="button" class="layui-btn layui-btn-danger">ç™»å½•</button>
                </div>
            </form>
        </div>
    </section>
</div>
<script src="{% static 'layui/layui.all.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<!-- æ³¨æ„ï¼šå¦‚æœä½ ç›´æ¥å¤åˆ¶æ‰€æœ‰ä»£ç åˆ°æœ¬åœ°ï¼Œä¸Šè¿°jsè·¯å¾„éœ€è¦æ”¹æˆä½ æœ¬åœ°çš„ -->
<script>
    layui.use(['layer', 'form'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            form = layui.form;

        // ajaxåŠ è½½åŠ¨ç”»
        var load
        $(document).on('ajaxStart', function () {
            load = layer.load();
        })
        $(document).on('ajaxComplete', function () {
            layer.close(load);
        })

        // åˆ‡æ¢ä¸‹ä¸€é¡µ
        function next_show(btn) {
            index = $(btn).parents("form").index()
            $("form").eq(index + 1).siblings().hide()
            $("form").eq(index + 1).show().addClass("layui-anim layui-anim-scale")
            $("form").eq(index + 1).find(".form-button").show()
            $(".step-text").eq(index + 1).addClass("finish-text")
            $(".step-list").eq(index + 1).addClass("finish-list")
        }

        // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
        form.verify({
            password: [
                /^(?![a-zA-z]+$)(?!\d+$)(?![!@#$%^&*]+$)[a-zA-Z\d!@#$%^&*]{6,20}$/
                , 'å¯†ç å¿…é¡»6åˆ°20ä½ï¼Œæ•°å­—åŠ å­—æ¯ç»„åˆï¼'
            ],
            password_same: function () {
                var password1 = $("input[ name='password1' ]").val()
                var password2 = $("input[ name='password2' ]").val()
                if (password1 != password2) {
                    return 'å¯†ç ä¸ä¸€è‡´ï¼'
                }
            }
        })

        // ajaxéªŒè¯é‚®ç®±å·å­˜åœ¨
        function email_repeat(value) {
            var repeat = false;
            $.ajax({
                type: "GET",
                url: "{% url 'account:registerCheck' %}",
                async: false,
                data: {email: value},
                success: function (result) {
                    if (result.code == 1) {
                        repeat = true;
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
            return repeat;
        }

        // å‘é€é‚®ä»¶éªŒè¯ç 
        $("#send_btn").click(function () {
            var email = $(this).siblings("input").val()
            if (email.length == 0) {
                layer.msg("è¯·è¾“å…¥é‚®ç®±å·", {icon: 2})
                return false;
            }
            var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
            if (enoughRegex.test(email) == false) {
                layer.msg("è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±å·", {icon: 2})
                return false;
            }
            if ($("#send_btn").hasClass("layui-btn-disabled")) {
                layer.msg("éªŒè¯ç å·²å‘é€ï¼Œè¯·ç¨åå†è¯•", {icon: 2})
                return false;
            }
            if (email_repeat(email)) {
                layer.msg("é‚®ç®±å·æœªæ³¨å†Œï¼", {icon: 2})
                return false;
            }
            $.ajax({
                type: "GET",
                url: "{% url 'account:emailCode' %}",
                data: {
                    email: email,
                    action: "é‡ç½®å¯†ç "
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.msg, {icon: 1});
                        $("#send_btn").addClass("layui-btn-disabled");     //æ§åˆ¶æŒ‰é’®ä¸ºç¦ç”¨
                        var second = 60;
                        var intervalObj = setInterval(function () {
                            $("#send_btn").text("é‡æ–°è·å–" + "(" + second + ")");
                            if (second == 0) {
                                $("#send_btn").text("è·å–éªŒè¯ç ");
                                $("#send_btn").removeClass("layui-btn-disabled");//å°†æŒ‰é’®å¯ç”¨
                                /* æ¸…é™¤å·²è®¾ç½®çš„setIntervalå¯¹è±¡ */
                                clearInterval(intervalObj);
                            }
                            second--;
                        }, 1000);
                    } else {
                        layer.alert(result.msg, {icon: 2});
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        });
        // é‚®ç®±éªŒè¯é¡µä¸‹ä¸€æ­¥æŒ‰é’®
        form.on('submit(email)', function () {
            var email = $("input[ name='email']").val()
            var email_code = $("input[ name='email_code']").val()
            $.ajax({
                type: "POST",
                url: "{% url 'account:checkEmailCode' %}",
                data: {
                    email: email,
                    email_code: email_code
                },
                success: function (result) {
                    if (result.code == 1) {
                        next_show($("#email_next"));
                    } else {
                        layer.alert(result.msg, {icon: 2});
                        $("input[ name='email_code' ]").val("");
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        })
        // å¯†ç è®¾ç½®é¡µä¸Šä¸€æ­¥æŒ‰é’®
        $(".layui-btn-warm").click(function () {
            $("form").eq(0).siblings().hide();
            $("form").eq(0).show().addClass("layui-anim layui-anim-scale");
            $("form").eq(0).find(".form-button").show();
            $(".step-text").eq(1).removeClass("finish-text");
            $(".step-list").eq(1).removeClass("finish-list");
        })
        // å¯†ç è®¾ç½®é¡µä¸‹ä¸€æ­¥æŒ‰é’®
        form.on('submit(password)', function () {
            var email = $("input[ name='email' ]").val();
            var email_code = $("input[ name='email_code' ]").val();
            var password1 = $("input[ name='password1' ]").val();
            var password2 = $("input[ name='password2' ]").val();
            $.ajax({
                type: "POST",
                url: "{% url 'account:forgetPassword' %}",
                data: {
                    email: email,
                    email_code: email_code,
                    password1: password1,
                    password2: password2,
                },
                success: function (result) {
                    if (result.code == 1) {
                        next_show($("#password_next"));
                    } else {
                        layer.alert(result.msg, {icon: 2});
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        })
        // é‡ç½®å®Œæˆç™»å½•æŒ‰é’®
        $(".layui-btn-danger").click(function () {
            window.location.href = "{% url 'account:loginRegister' %}"
        })
    })
</script>

</body>
</html>