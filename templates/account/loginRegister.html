{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <title>登录&注册</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'bootstrap-4.5.0/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <link rel="stylesheet" href="{% static 'fontawesome-free-5.11.2-web/css/all.min.css' %}" media='all'/>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?5abb8d046dd1dd0d2ff4094f445b3079";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
<div class="section">
    <div class="container">
        <div class="row full-height justify-content-center">
            <div class="col-12 text-center align-self-center">
                <div class="section pb-5 pt-sm-2 text-center">
                    <h3 class="mb-0 pb-3 change-title"><span>登录&nbsp;</span><span>&nbsp;注册</span></h3>
                    <input class="checkbox" type="checkbox" id="reg-log" name="reg-log"/>
                    <label for="reg-log"></label>
                    <div class="card-3d-wrap mx-auto">
                        <div class="card-3d-wrapper">
                            <div class="card-front">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">登&nbsp;录</h4>
                                        <form id="login" class="layui-form" method="post">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                {{ login_form.user }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                            </div>
                                            <div class="form-group mt-2">
                                                {{ login_form.password }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                            </div>
                                            <div class="form-group mt-2 verification">
                                                <input id="id_reg_captcha_0" name="captcha_0" type="hidden"
                                                       value="{{ hashkey }}">
                                                <input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text"
                                                       class="form-style" placeholder="验证码" lay-verify="required"
                                                       lay-reqtext="请输入验证码！">
                                                <a href="javascript:;" title="点击刷新验证码">
                                                    <img src="{{ image_url }}" alt="captcha" class="captcha"></a>
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                            </div>
                                            <input type="submit" name="type" value="登录" class="btn mt-4" lay-submit="">
                                            <a href="{% url 'account:forgetPassword' %}"
                                               class="link forget">忘记密码?</a>
                                        </form>
                                        <div>
                                            <h6 class="mb-0 mt-4 text-center">社交账号免注册登录</h6>
                                            <div class="layui-btn-group">
                                                <button type="button"
                                                        onclick="window.location.href = '{% url 'social:begin' 'qq' %}'"
                                                        class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-qq"></i></button>
                                                <button type="button"
                                                        onclick="window.location.href = '{% url 'social:begin' 'github' %}'"
                                                        class="layui-btn layui-btn-normal"><i
                                                        class="fab fa-github fa-lg"></i></button>
                                                <button type="button"
                                                        onclick="window.location.href = '{% url 'social:begin' 'weibo' %}'"
                                                        class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-weibo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="pb-3">注&nbsp;册</h4>
                                        <form id="register" class="layui-form">
                                            <div class="form-group" id="username">
                                                {{ register_form.username }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                            </div>
                                            <div class="form-group mt-2" id="email">
                                                {{ register_form.email }}
                                                <i class="input-icon layui-icon layui-icon-email"></i>
                                                <button type="button" class="layui-btn layui-btn-primary"
                                                        layui-submit="" id="send_btn">
                                                    获取验证码
                                                </button>
                                            </div>
                                            <div class="form-group mt-2" id="email_code">
                                                {{ register_form.email_code }}
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                            </div>
                                            <div class="form-group mt-2" id="password1">
                                                {{ register_form.password1 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                            </div>
                                            <div class="form-group mt-2" id="password2">
                                                {{ register_form.password2 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                            </div>
                                            <button type="button" class="btn mt-4" lay-submit="" lay-filter="register">
                                                注册
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'layui/layui.all.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<script>

    layui.use(['form', 'layer'], function () {
        var form = layui.form
            , $ = layui.jquery
            , layer = layui.layer;
        // 登录提示信息
        var message = '{{ message }}';
        if (message) {
            layer.alert(message, {icon: 2})
        }
        // ajax加载动画
        var load
        $(document).on('ajaxStart', function () {
            load = layer.load();
        })
        $(document).on('ajaxComplete', function () {
            layer.close(load);
        })

        // 刷新验证码
        $('.captcha').click(function () {
            $.getJSON("/captcha/refresh/", function (result) {
                $('.captcha').attr('src', result['image_url']);
                $('#id_captcha_0').val(result['key'])
            });
        });
        // 自定义验证规则
        form.verify({
            username: function (value) { //value：表单的值、item：表单的DOM对象
                if (value.length < 3 || value.length > 10) {
                    return '用户名长度3到10位！'
                }
                if (/^\d+\d+\d$/.test(value)) {
                    return '用户名不能全为数字！';
                }
                if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                    return '用户名不能有特殊字符！';
                }
                if (/(^\_)|(\__)|(\_+$)/.test(value)) {
                    return '用户名首尾不能出现下划线\'_\'';
                }
            },
            check_username: function (value) {
                if (username_repeat(value)) {
                    return '用户名已注册！';
                }
            },
            check_email: function (value) {
                if (email_repeat(value)) {
                    return '邮箱已注册！'
                }
            },
            password: [
                /^(?![a-zA-z]+$)(?!\d+$)(?![!@#$%^&*]+$)[a-zA-Z\d!@#$%^&*]{6,20}$/
                , '密码必须6到20位，数字加字母组合！'
            ],
            password_same: function () {
                var password1 = $("input[ name='password1' ]").val()
                var password2 = $("input[ name='password2' ]").val()
                if (password1 != password2) {
                    return '密码不一致！'
                }
            }
        });

        // ajax验证用户名存在
        function username_repeat(value) {
            var repeat = false;
            $.ajax({
                type: "GET",
                url: "{% url 'account:registerCheck' %}",
                async: false,
                data: {username: value},
                success: function (result) {
                    if (result.code == 0) {
                        repeat = true;
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
            return repeat;
        }

        // ajax验证邮箱号存在
        function email_repeat(value) {
            var repeat = false;
            $.ajax({
                type: "GET",
                url: "{% url 'account:registerCheck' %}",
                async: false,
                data: {email: value},
                success: function (result) {
                    if (result.code == 0) {
                        repeat = true;
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
            return repeat;
        }

        // 发送邮件验证码
        $("#send_btn").click(function () {
            var email = $(this).siblings("input").val()
            if (email.length == 0) {
                layer.msg("请输入邮箱号", {icon: 2})
                return false;
            }
            var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
            if (enoughRegex.test(email) == false) {
                layer.msg("请输入正确的邮箱号", {icon: 2})
                return false;
            }
            if ($("#send_btn").hasClass("layui-btn-disabled")) {
                layer.msg("验证码已发送，请稍后再试", {icon: 2})
                return false;
            }
            if (email_repeat(email)) {
                layer.msg("邮箱号已注册！", {icon: 2})
                return false;
            }
            $.ajax({
                type: "GET",
                url: "{% url 'account:emailCode' %}",
                data: {
                    email: email,
                    action: "注册新用户"
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.msg, {icon: 1});
                        $("#send_btn").addClass("layui-btn-disabled");     //控制按钮为禁用
                        var second = 60;
                        var intervalObj = setInterval(function () {
                            $("#send_btn").text("重新获取" + "(" + second + ")");
                            if (second == 0) {
                                $("#send_btn").text("获取验证码");
                                $("#send_btn").removeClass("layui-btn-disabled");//将按钮可用
                                /* 清除已设置的setInterval对象 */
                                clearInterval(intervalObj);
                            }
                            second--;
                        }, 1000);
                    } else {
                        layer.alert(result.msg, {icon: 2});
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        });

        // 注册表单提交
        form.on('submit(register)', function () {
            var username = $("input[ name='username' ]").val();
            var email = $("input[ name='email' ]").val();
            var email_code = $("input[ name='email_code' ]").val();
            var password1 = $("input[ name='password1' ]").val();
            var password2 = $("input[ name='password2' ]").val();
            $.ajax({
                type: "POST",
                url: "{% url 'account:loginRegister' %}",
                data: {
                    username: username,
                    email: email,
                    email_code: email_code,
                    password1: password1,
                    password2: password2,
                    type: "注册",
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.msg, {icon: 6});
                        setTimeout(function () {
                            window.location.href = "/";
                        }, 1000);
                    } else {
                        layer.alert(result.msg, {icon: 2});
                        $("input[ name='email_code' ]").val("");
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        })
        // 第三方账号登录
        $(".layui-btn-group button").click(function () {
            layer.msg("正在跳转至第三方登录页，请稍候！")
        })
    });
</script>
</body>
</html>