{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>个人中心—首页</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="{% static 'layui-mini/lib/layui-v2.5.5/css/layui.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'fontawesome-free-5.11.2-web/css/all.min.css' %}" media='all'/>
    <link rel="stylesheet" href="{% static 'layui-mini/css/public.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'css/layui-mini.css' %}" media="all">
    <style>
        .top-panel {
            border: 1px solid #eceff9;
            border-radius: 5px;
            text-align: center;
        }

        .top-panel > .layui-card-body {
            height: 60px;
        }

        .top-panel-number {
            line-height: 60px;
            font-size: 30px;
            border-right: 1px solid #eceff9;
        }

        .top-panel-tips {
            line-height: 30px;
            font-size: 12px
        }
    </style>
</head>
<body>
<!--<div class="layuimini-container">-->
<div class="layuimini-main">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-xs12 layui-col-md6">
            <div class="layui-card top-panel">
                <div class="layui-card-header">我的信息</div>
                <div class="layui-field-box">
                    <table class="layui-table" lay-even="" lay-skin="nob">
                        <thead>
                        <tr>
                            <th>用户名：</th>
                            <th>{{ user.username }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>性别：</td>
                            <td>{{ userinfo.get_sex_display }}</td>
                        </tr>
                        <tr>
                            <td>邮箱：</td>
                            {% if user.email %}
                                <td>{{ user.email }}</td>
                            {% else %}
                                <td>为了您的账户安全，请立即
                                    <button id="bind-email" type="button" class="layui-btn layui-btn-normal"
                                            style="height: 20px;line-height: 0">绑定邮箱
                                    </button>
                                </td>
                            {% endif %}
                        </tr>
                        <tr>
                            <td>手机：</td>
                            <td>{{ userinfo.phone }}</td>
                        </tr>
                        <tr>
                            <td>个人站点：</td>
                            <td>{{ userinfo.web }}</td>
                        </tr>
                        <tr>
                            <td>个性签名：</td>
                            <td>{{ userinfo.aboutme }}</td>
                        </tr>
                        <tr>
                            <td>注册时间：</td>
                            <td>{{ user.date_joined }}</td>
                        </tr>
                        <tr>
                            <td>上次登录时间：</td>
                            <td>{{ user.last_login }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-xs12 layui-col-md6">
            <div class="layui-card top-panel">
                <div class="layui-card-header">我的统计</div>
                <div class="layui-field-box layui-row layui-col-space15">
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-blue">文章</span>
                                    <h3>浏览文章数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ article_view }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-blue">文章</span>
                                    <h3>收藏文章数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ article_like }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-blue">文章</span>
                                    <h3>评论文章数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ article_comment }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-green">笔记</span>
                                    <h3>浏览笔记数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ section_view }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-green">笔记</span>
                                    <h3>收藏笔记数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ section_like }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6 layui-col-md4">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-green">笔记</span>
                                    <h3>评论笔记数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ section_comment }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs12 layui-col-md12">
                        <div class="panel layui-bg-number">
                            <div class="panel-body">
                                <div class="panel-title">
                                    <span class="label pull-right layui-bg-orange">留言</span>
                                    <h3>发表留言数</h3>
                                </div>
                                <div class="panel-content">
                                    <h1 class="no-margins">{{ leave_count }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-row layui-col-space15">
        <div class="layui-col-xs12 layui-col-md9">
            <div class="layui-card">
                <div class="layui-card-header">浏览趋势</div>
                <div class="layui-card-body">
                    <div id="echarts-records" style="background-color:#ffffff;min-height:400px;padding: 10px"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-xs12 layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">浏览文章分布</div>
                <div class="layui-card-body">
                    <div id="echarts-pies" style="background-color:#ffffff;min-height:400px;padding: 10px"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space15">
        <div class="layui-col-xs12 layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">浏览笔记分布</div>
                <div class="layui-card-body">
                    <div id="echarts-map" style="background-color:#ffffff;min-height:400px;padding: 10px"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-xs12 layui-col-md9">
            <div class="layui-card">
                <div class="layui-card-header">浏览时间分布</div>
                <div class="layui-card-body">
                    <div id="echarts-dataset" style="background-color:#ffffff;min-height:400px;padding: 10px"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="bind-email-box" class="layui-hide">
        <div class="collection-box-div">
            <div class="layui-form-item">
                <label class="layui-form-label">邮箱号:</label>
                <div class="layui-input-inline">
                    <input type="text" name="email" lay-verify="email" autocomplete="off" placeholder="请输入邮箱号"
                           class="layui-input">
                </div>
                <button type="button" class="layui-btn layui-btn-normal" id="send_btn">发送验证码</button>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">验证码:</label>
                <div class="layui-input-inline">
                    <input type="text" name="code" lay-verify="title" autocomplete="off" placeholder="请输入验证码"
                           class="layui-input">
                </div>
            </div>
        </div>
    </div>
</div>
<!--</div>-->
<script src="{% static 'layui-mini/lib/layui-v2.5.5/layui.js' %}" charset="utf-8"></script>
<script src="{% static 'layui-mini/js/lay-config.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<script src="{% static 'echarts/echarts.min.js' %}" charset="utf-8"></script>
<script src="{% static 'echarts/wonderland.js' %}" charset="utf-8"></script>

<script>
    layui.use(['layer'], function () {
        var $ = layui.jquery,
            layer = layui.layer;
        $('#bind-email').click(function () {
            var index = layer.open({
                title: '绑定邮箱',
                type: 1,
                area: ['500px', '270px'],
                shade: 0.2,
                shadeClose: true,
                content: $('#bind-email-box').html(),
                btn: ['确定', '取消'],
                btnAlign: 'c',
                success: function (layero, index) {
                    layero.find("#send_btn").click(function () {
                        var email = layero.find('input[name="email"]').val()
                        // 发送邮件验证码
                        if (email.length == 0) {
                            layer.msg("请输入邮箱号", {icon: 2})
                            return false;
                        }
                        var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
                        if (enoughRegex.test(email) == false) {
                            layer.msg("请输入正确的邮箱号", {icon: 2})
                            return false;
                        }
                        if ($("#send_btn").hasClass("layui-btn-disabled")) {
                            layer.msg("验证码已发送，请稍后再试", {icon: 2})
                            return false;
                        }
                        if (email_repeat(email)) {
                            layer.msg("该邮箱号已被绑定！", {icon: 2})
                            return false;
                        }
                        $.ajax({
                            type: "GET",
                            url: "{% url 'account:emailCode' %}",
                            data: {
                                email: email,
                                action: "绑定邮箱",
                                username: "{{ user.username }}",
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    layer.msg(result.msg, {icon: 1});
                                    layero.find("#send_btn").addClass("layui-btn-disabled");     //控制按钮为禁用
                                    var second = 60;
                                    var intervalObj = setInterval(function () {
                                        layero.find("#send_btn").text("重新获取" + "(" + second + ")");
                                        if (second == 0) {
                                            layero.find("#send_btn").text("获取验证码");
                                            layero.find("#send_btn").removeClass("layui-btn-disabled");//将按钮可用
                                            /* 清除已设置的setInterval对象 */
                                            clearInterval(intervalObj);
                                        }
                                        second--;
                                    }, 1000);
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })

                        // ajax验证邮箱号存在
                        function email_repeat(value) {
                            var repeat = false;
                            $.ajax({
                                type: "GET",
                                url: "{% url 'account:registerCheck' %}",
                                async: false,
                                data: {email: value},
                                success: function (result) {
                                    if (result.code == 0) {
                                        repeat = true;
                                    }
                                },
                                error: function (xhr) {
                                    alert(xhr.text());
                                }
                            })
                            return repeat;
                        }
                    })
                },
                yes: function (layero, index) {
                    var email = index.find('input[name="email"]').val()
                    var code = index.find('input[name="code"]').val()
                    // 发送邮件验证码
                    if (email.length == 0) {
                        layer.msg("请输入邮箱号", {icon: 2})
                        return false;
                    }
                    if (code.length == 0) {
                        layer.msg("请输入验证码", {icon: 2})
                        return false;
                    }
                    $.ajax({
                        type: "POST",
                        url: "{% url 'account:bindEmail' %}",
                        data: {
                            email: email,
                            code: code,
                        },
                        success: function (result) {
                            if (result.code == 1) {
                                layer.msg(result.msg, {icon: 1});
                                layer.closeAll();
                                window.location.reload();
                            } else {
                                layer.alert(result.msg, {icon: 2});
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                },
                btn2: function () {
                    layer.closeAll();
                }
            });
        })
    });
</script>
<script>
    // 浏览趋势
    var echartsRecords = echarts.init(document.getElementById('echarts-records'), 'wonderland');
    $.ajax({
        type: "GET",
        url: "{% url 'management:echartsData' %}",
        data: {
            type: "view",
        },
        success: function (result) {
            // console.log(result)
            if (result.code == 1) {
                var optionRecords = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#6a7985'
                            }
                        }
                    },
                    legend: {
                        data: ['浏览文章数', '收藏文章数', '评论文章数', '浏览笔记数', '收藏笔记数', '评论笔记数']
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            boundaryGap: false,
                            data: result.data.xAxis
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '浏览文章数',
                            type: 'line',
                            stack: '总量',
                            areaStyle: {},
                            data: result.data.article_view
                        },
                        {
                            name: '收藏文章数',
                            type: 'line',
                            areaStyle: {},
                            data: result.data.article_like
                        },
                        {
                            name: '评论文章数',
                            type: 'line',
                            stack: '总量',
                            areaStyle: {},
                            data: result.data.article_comment
                        },
                        {
                            name: '浏览笔记数',
                            type: 'line',
                            stack: '总量',
                            areaStyle: {},
                            data: result.data.section_view
                        },
                        {
                            name: '收藏笔记数',
                            type: 'line',
                            areaStyle: {},
                            data: result.data.section_like
                        },
                        {
                            name: '评论笔记数',
                            type: 'line',
                            stack: '总量',
                            areaStyle: {},
                            data: result.data.section_comment
                        }
                    ]
                };
                echartsRecords.setOption(optionRecords);
            } else {
                layer.alert(result.msg, {icon: 2});
            }
        },
        error: function (xhr) {
            alert(xhr.text());
        }
    })
    // 浏览文章分类
    var echartsPies = echarts.init(document.getElementById('echarts-pies'), 'wonderland');
    $.ajax({
        type: "GET",
        url: "{% url 'management:echartsData' %}",
        data: {
            type: "category",
        },
        success: function (result) {
            // console.log(result)
            if (result.code == 1) {
                var optionPies = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b} : {c} ({d}%)'
                    },
                    legend: {
                        type: 'scroll',
                        orient: 'horizontal',
                        top: 'left',
                        data: result.data.legend
                    },
                    series: [
                        {
                            name: '浏览文章分布',
                            type: 'pie',
                            radius: '55%',
                            center: ['50%', '60%'],
                            roseType: 'radius',
                            data: result.data.series,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                echartsPies.setOption(optionPies);
            } else {
                layer.alert(result.msg, {icon: 2});
            }
        },
        error: function (xhr) {
            alert(xhr.text());
        }
    })
    // 浏览笔记分类
    var echartsMap = echarts.init(document.getElementById('echarts-map'), 'wonderland');
    $.ajax({
        type: "GET",
        url: "{% url 'management:echartsData' %}",
        data: {
            type: "note",
        },
        success: function (result) {
            // console.log(result)
            if (result.code == 1) {
                var optionMap = {
                    tooltip: {},
                    legend: {
                        data: ['笔记浏览分布']
                    },
                    radar: {
                        // shape: 'circle',
                        name: {
                            textStyle: {
                                color: '#fff',
                                backgroundColor: '#999',
                                borderRadius: 3,
                                padding: [3, 5]
                            }
                        },
                        indicator: result.data.indicator
                    },
                    series: [{
                        type: 'radar',
                        // areaStyle: {normal: {}},
                        data: [
                            {
                                value: result.data.serise,
                                name: '笔记浏览分布'
                            }
                        ]
                    }]
                };
                echartsMap.setOption(optionMap);
            } else {
                layer.alert(result.msg, {icon: 2});
            }
        },
        error: function (xhr) {
            alert(xhr.text());
        }
    })
    // 浏览时间分布
    var echartsDataset = echarts.init(document.getElementById('echarts-dataset'), 'wonderland');
    $.ajax({
        type: "GET",
        url: "{% url 'management:echartsData' %}",
        data: {
            type: "time",
        },
        success: function (result) {
            // console.log(result)
            if (result.code == 1) {
                var optionDataset = option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    legend: {
                        data: ['访问文章', '访问笔记']
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    yAxis: {
                        type: 'value'
                    },
                    xAxis: {
                        type: 'category',
                        data: ['00-01', '02-03', '04-05', '06-07', '08-09', '10-11', '12-13', '14-15', '16-17', '18-19', '20-21', '22-23']
                    },
                    series: [
                        {
                            name: '访问文章',
                            type: 'bar',
                            stack: '总量',
                            label: {
                                show: true,
                                position: 'insideRight'
                            },
                            data: result.data.article
                        },
                        {
                            name: '访问笔记',
                            type: 'bar',
                            stack: '总量',
                            label: {
                                show: true,
                                position: 'insideRight'
                            },
                            data: result.data.section
                        }
                    ]
                };
                echartsDataset.setOption(optionDataset);
            } else {
                layer.alert(result.msg, {icon: 2});
            }
        },
        error: function (xhr) {
            alert(xhr.text());
        }
    })
    // echarts 窗口缩放自适应
    window.onresize = function () {
        echartsRecords.resize();
        echartsPies.resize();
        echartsMap.resize();
        echartsDataset.resize();
    }
</script>
</body>
</html>
