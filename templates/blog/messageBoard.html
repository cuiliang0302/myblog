{% extends 'base-blog.html' %}
{% load static %}
{% block title %}ÁïôË®ÄÊùø{% endblock %}
{% block link %}
    <script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
{% endblock %}
{% block content %}
    <!--‰∏≠Èó¥‰∏ª‰ΩìÈÉ®ÂàÜ-->
    <main class="page-main">
        <div class="layui-row">
            <!--    È°µÈù¢‰∏ª‰ΩìÈÉ®ÂàÜ-->
            <div class="layui-col-md-offset2 layui-col-sm12 layui-col-md8 page-main-centre">
                <div class="layui-row main-centre">
                    <!--            ‰∏ª‰ΩìÂ∑¶‰æßÈÉ®ÂàÜ-->
                    <div class="layui-col-md9 main-left">
                        <div class="index-new message-board">
                            <div class="message-editor">
                                <div class="message-title clearfix">
                                    <div><h1>üìù ÊàëË¶ÅÁïôË®Ä</h1></div>
                                    <div><em>{{ count }}Êù°ÁïôË®Ä</em></div>
                                </div>
                                <hr class="layui-bg-gray">
                                <div class="layui-row message-body">
                                    <div class="layui-hide-xs layui-col-md1">
                                        <a>
                                            {% if userinfo.photo %}
                                                <img lay-src="{{ MEDIA_URL }}{{ userinfo.photo }}" class="layui-nav-img img-rotate">
                                            {% else %}
                                                <img lay-src="{{ MEDIA_URL }}{{ img.photo }}" class="layui-nav-img img-rotate">
                                            {% endif %}
                                        </a>
                                    </div>
                                    <div class="layui-col-xs12 layui-col-md10">
                                        <textarea id="leave"></textarea>
                                    </div>
                                    <div class="layui-col-xs2 layui-col-md1">
                                        <button type="button" class="layui-btn layui-btn-normal">ÁïôË®Ä</button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab">
                                <ul class="layui-tab-title">
                                    <li class="layui-this">ÂÖ®ÈÉ®ÁïôË®Ä</li>
                                    <li>ÁÉ≠Èó®ÁïôË®Ä</li>
                                    <li>ÊàëÁöÑÁïôË®Ä</li>
                                </ul>
                                <div class="layui-tab-content">
                                    {#                                    ÊúÄÊñ∞ÁïôË®Ä#}
                                    <div class="layui-tab-item layui-show">
                                        {% for ol in all_message %}
                                            <ol class="list-body">
                                                {% for li in ol %}
                                                    <li class="reply-{{ li.level }} message-content"
                                                        id="all-{{ li.id }}">
                                                        <a href={{ li.web }} target="_blank">
                                                            <img lay-src="{{ MEDIA_URL }}{{ li.photo }}"
                                                                 class="layui-nav-img img-rotate">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                {% if li.reply_name == 'None' %}
                                                                    <a href={{ li.web }} target="_blank">{{ li.username }}</a>
                                                                {% else %}
                                                                    <a href={{ li.web }} target="_blank">{{ li.username }}</a>
                                                                    <em>ÂõûÂ§ç</em>
                                                                    <a href={{ li.reply_web }} target="_blank">{{ li.reply_name }}</a>
                                                                {% endif %}
                                                                <span class="timeago" datetime="{{ li.time }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ li.content | safe }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>Ëµû<em>{{ li.like }}</em></a>
                                                                {% if li.username == user.username %}
                                                                    <a href="javascript:;" class="action-reply click-no"><i
                                                                        class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>
                                                                {% else %}
                                                                    <a href="javascript:;" class="action-reply"><i
                                                                        class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>
                                                                {% endif %}
                                                                {% if li.username == user.username %}
                                                                    <a href="javascript:;" class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete click-no"><i
                                                                            class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ol>
                                        {% endfor %}
                                    </div>
                                    {#ÁÉ≠Èó®ÁïôË®Ä#}
                                    <div class="layui-tab-item">
                                        <ol class="list-body">
                                            {% for i in hot_message %}
                                                <li class="message-content" id="hot-{{ i.id }}">
                                                    <a href={{ i.user.userinfo.web }} target="_blank">
                                                        <img src="{{ MEDIA_URL }}{{ i.user.userinfo.photo }}"
                                                             class="layui-nav-img img-rotate">
                                                    </a>
                                                    <div class="text-box">
                                                        <div class="box-info">
                                                            <a href={{ i.user.userinfo.web }} target="_blank">{{ i.user.username }}</a>
                                                            <span class="timeago"
                                                                  datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                        </div>
                                                        <div class="box-body">
                                                            {{ i.content | safe }}
                                                        </div>
                                                        <div class="box-action">
                                                            <a href="javascript:;" class="action-like"><i
                                                                    class="fas fa-thumbs-up"></i>Ëµû<em>{{ i.like }}</em></a>
                                                            <a href="javascript:;" class="action-reply click-no"><i
                                                                    class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>
                                                            {% if i.user.username == user.username %}
                                                                <a href="javascript:;" class="action-delete"><i
                                                                        class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                            {% else %}
                                                                <a href="javascript:;"
                                                                   class="action-delete click-no"><i
                                                                        class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ol>
                                    </div>
                                    {#                                        ÊàëÁöÑÁïôË®Ä#}
                                    <div class="layui-tab-item">
                                        {% if my_message %}
                                            <ol class="list-body">
                                                {% for i in my_message %}
                                                    <li class="message-content" id="my-{{ i.id }}">
                                                        <a href={{ i.user.userinfo.web }} target="_blank">
                                                            <img src="{{ MEDIA_URL }}{{ i.user.userinfo.photo }}"
                                                                 class="layui-nav-img img-rotate">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                <a href={{ i.user.userinfo.web }} target="_blank">{{ i.user.username }}</a>
                                                                <span class="timeago"
                                                                      datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ i.content |safe }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>Ëµû<em>{{ i.like }}</em></a>
                                                                <a href="javascript:;" class="action-reply click-no"><i
                                                                        class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>
                                                                {% if i.user.username == user.username %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete click-no"><i
                                                                            class="fas fa-trash-alt"></i>Âà†Èô§</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                                {% else %}
                                                <h3>ü•∫ÊÇ®ËøòÊ≤°ÊúâÁïôË®ÄÔºåÂø´Êù•ÁïôË®ÄÂêßÔºÅ</h3>
                                            </ol>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% include 'blog/aside.html' %}
                    <!--            ‰∏ª‰ΩìÂè≥‰æßÈÉ®ÂàÜ-->
                </div>
            </div>
        </div>
        {#        ÂõûÂ§çÁïôË®ÄÂºπÁ™ó#}
        <div id="reply-div">
            <textarea id="reply" style="display: none;"></textarea>
        </div>
        {#        ÂèëË°®ÁïôË®ÄÂºπÁ™ó#}
        <div id="collection-box" class="layui-hide">
            <div class="collection-box-div">
                ÊÇ®Â∞öÊú™ÁôªÂΩïÔºåËØ∑ÂÖàÁôªÂΩïÁÑ∂ÂêéÂèëË°®ÁïôË®Ä
            </div>
        </div>
    </main>
{% endblock %}

{% block js %}
    <script>
        // ÂØºËà™Ê†èÂΩìÂâçÊ†áÁ≠æÈ°µ
        $(".nav5").addClass("layui-this");
        layui.use(['form', 'layedit'], function () {
            var form = layui.form;
            var $ = layui.jquery;
            var layedit = layui.layedit;
            var reply_textarea;
            // ÂØåÊñáÊú¨ÁºñËæëÂô®
            form.render(); //Êõ¥Êñ∞ÂÖ®ÈÉ®
            // ÂõæÁâáÊé•Âè£ÊîæÂà∞Âª∫Á´ãÁºñËæëÂô®ÂâçÈù¢ÔºåÂê¶ÂàôÊó†Êïà
            layedit.set({
                uploadImage: {
                    url: '{% url "account:commentUpload" %}', //Êé•Âè£url
                    type: 'post', //ÈªòËÆ§post
                }
            });
            // ËÆæÁΩÆÂèëË°®ÁïôË®ÄÁºñËæëÂô®
            var index = layedit.build('leave', {
                height: 150 //ËÆæÁΩÆÁºñËæëÂô®È´òÂ∫¶
                , tool: ['face', 'image', '|', 'link', 'unlink']
            });
            // Âª∫Á´ãÂèëË°®ÁïôË®ÄÁºñËæëÂô®
            form.verify({ // ËøôÈáåÂ∞±ÊòØÊääÂØåÊñáÊú¨Êï∞ÊçÆÂêåÊ≠•Âà∞<textarea>‰∏≠
                content: function (value) {
                    return layedit.sync(index);
                }
            });
            // ÂèëË°®ÁïôË®ÄÊåâÈíÆ‰∫ã‰ª∂
            $(".message-body button").click(function () {
                var $content = layedit.getContent(index)
                if ('{{ user.id }}' == 'None') {
                    layer.open({
                        type: 1,
                        title: 'ÂèëÂ∏ÉÁïôË®Ä',
                        shadeClose: true,
                        content: $('#collection-box').html(),
                        btn: ['ÁôªÂΩï'],
                        btnAlign: 'c',
                        yes: function (index) {
                            window.location.href = "{% url 'account:loginRegister' %}?next=" + window.location.pathname
                            layer.close(index);
                        }
                    })
                    return false;
                }
                if ($content.length == 0) {
                    layer.msg('‰∫≤~ËØ∑ÂÖàËæìÂÖ•ÂÜÖÂÆπÔºåÁÑ∂ÂêéÂÜçÊèê‰∫§Âì¶ÔºÅ', {icon: 5});
                    return false;
                }
                $.ajax({
                    type: "GET",
                    url: "{% url 'blog:postMessage' %}",
                    data: {
                        content: layedit.getContent(index),
                        username: "{{ user.username }}",
                        level: 0
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            // ÊñáÊú¨ÂüüÂÜÖÂÆπÈùûÁ©∫ÔºåÂàõÂª∫ËäÇÁÇπ
                            var $record = createEle($content);
                            $(".layui-tab-item").prepend($record);
                            var timeago = layui.timeago;
                            timeago.render($('.timeago'));
                            layer.msg(result.msg, {icon: 6});
                            layui.layedit.clearContent(index);
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // ÁïôË®ÄÁÇπËµû
            $("body").delegate(".action-like", "click", function () {
                var num = $(this).find("em").text();
                var $like_click = $(this);
                var like_id = $like_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                $.ajax({
                    type: "GET",
                    url: "{% url 'blog:likeMessage' %}",
                    data: {
                        like_id: like_id,
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            $like_click.find("em").html(parseInt(num) + 1);
                            $like_click.addClass("click-no");
                            layer.msg(result.msg, {icon: 6});
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // ÁïôË®ÄÂà†Èô§
            $("body").delegate(".action-delete", "click", function () {
                var $del_click = $(this)
                var del_id = $del_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                var del_level = $del_click.parents(".message-content").attr("class").replace(/[^\d]/g, '')
                var reply_count = $del_click.parents(".list-body").find("li").length
                layer.msg('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÁïôË®ÄÂÜÖÂÆπÂêóÔºü', {
                    time: 10000, //10sÂêéËá™Âä®ÂÖ≥Èó≠
                    btnAlign: 'c',
                    btn: ['Á°ÆÂÆö', 'ÂèñÊ∂à'],
                    yes: function (index) {
                        layer.close(index);
                        $.ajax({
                            type: "GET",
                            url: "{% url 'blog:delMessage' %}",
                            data: {
                                del_id: del_id,
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    if (del_level == 0 && reply_count == 1) {
                                        $del_click.parents(".message-content").remove();
                                    } else {
                                        $del_click.parents(".text-box").find(".box-body").html("ËØ•ÂÜÖÂÆπÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§");
                                    }
                                    layer.msg(result.msg, {icon: 6});
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    },
                });
            })
            // ÁïôË®ÄÂõûÂ§ç
            $("body").delegate(".action-reply", "click", function () {
                $reply_click = $(this);
                layer.open({
                    type: 1
                    , title: 'ÂõûÂ§çÁïôË®Ä'
                    , area: ['400px', '300px']
                    , offset: 'auto'
                    , content: $('#reply-div').html()
                    , btn: ['ÂèëË°®ÂõûÂ§ç', 'ÂèñÊ∂àÂõûÂ§ç']
                    , btnAlign: 'c'
                    , yes: function () {
                        $content = layedit.getContent(reply_textarea);
                        if ($content.length == 0) {
                            layer.msg('‰∫≤~ËØ∑ÂÖàËæìÂÖ•ÂÜÖÂÆπÔºåÁÑ∂ÂêéÂÜçÊèê‰∫§Âì¶ÔºÅ', {icon: 5});
                            return false;
                        }
                        var reply_level = parseInt($reply_click.parents(".message-content").attr("class").replace(/[^\d]/g, '')) + 1
                        var reply_id = $reply_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                        var root_id = $reply_click.parents(".list-body").find("li").eq(0).attr("id").replace(/[^\d]/g, '')
                        $.ajax({
                            type: "GET",
                            url: "{% url 'blog:postMessage' %}",
                            data: {
                                content: layedit.getContent(reply_textarea),
                                username: "{{ user.username }}",
                                level: reply_level,
                                reply_id: reply_id,
                                root_id: root_id
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    // ÊñáÊú¨ÂüüÂÜÖÂÆπÈùûÁ©∫ÔºåÂàõÂª∫ËäÇÁÇπ
                                    var $record = createReplyEle($content,reply_id,reply_level);
                                    var insert_id = "#all-"+reply_id
                                    $(insert_id).after($record);
                                    var timeago = layui.timeago;
                                    timeago.render($('.timeago'));
                                    layer.msg(result.msg, {icon: 6});
                                    layui.layedit.clearContent(index);
                                    layer.closeAll();
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    }
                    , btn2: function () {
                        layer.closeAll();
                    },
                    success: function (layero, index) {
                        // ËÆæÁΩÆÂèëË°®ÁïôË®ÄÁºñËæëÂô®
                        reply_textarea = layedit.build($(layero).find('#reply'), {
                            height: 150 //ËÆæÁΩÆÁºñËæëÂô®È´òÂ∫¶
                            , tool: ['face', 'image', '|', 'link', 'unlink']
                        });
                        // ÊääÂØåÊñáÊú¨Êï∞ÊçÆÂêåÊ≠•Âà∞<textarea>‰∏≠
                        form.verify({
                            content: function (value) {
                                return layedit.sync(reply_textarea);
                            }
                        });
                    },
                });
            })

            // Ê†πÊçÆÂÜÖÂÆπÂàõÂª∫ÁïôË®ÄËäÇÁÇπ
            function createEle(content) {
                var $record = $('<ol class="list-body">\n' +
                    '            <li class="message-content">\n' +
                    '                <a href="#">\n' +
                    '                    <img src="{{ MEDIA_URL }}{{ userinfo.photo }}" class="layui-nav-img img-rotate">\n' +
                    '                </a>\n' +
                    '                <div class="text-box">\n' +
                    '                    <div class="box-info">\n' +
                    '                        <a href="#">{{ user.username }}</a>\n' +
                    '                        <span class="timeago" datetime="{% now "Y-m-d H:i:s" %}"></span>\n' +
                    '                    </div>\n' +
                    '                    <div class="box-body">\n' + content +
                    '                    </div>\n' +
                    '                    <div class="box-action">\n' +
                    '                        <a href="javascript:;" class="action-like"><i class="fas fa-thumbs-up"></i>Ëµû<em>0</em></a>\n' +
                    '                        <a href="javascript:;" class="action-reply"><i class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>\n' +
                    '                        <a href="javascript:;" class="action-delete"><i class="fas fa-trash-alt"></i>Âà†Èô§</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li>\n' +
                    '        </ol>')
                return $record;
            }
            // Ê†πÊçÆÂÜÖÂÆπÂàõÂª∫ÁïôË®ÄÂõûÂ§çËäÇÁÇπ
            function createReplyEle(content,reply_id,reply_level) {
                var $record = $('<ol class="list-body">\n' +
                    '            <li class="reply-'+reply_level+' message-content" id="all-'+reply_id+'">\n' +
                    '                <a href="#">\n' +
                    '                    <img src="{{ MEDIA_URL }}{{ userinfo.photo }}" class="layui-nav-img img-rotate">\n' +
                    '                </a>\n' +
                    '                <div class="text-box">\n' +
                    '                    <div class="box-info">\n' +
                    '                        <a href="#">{{ user.username }}</a>\n' +
                    '                        <span class="timeago" datetime="{% now "Y-m-d H:i:s" %}"></span>\n' +
                    '                    </div>\n' +
                    '                    <div class="box-body">\n' + content +
                    '                    </div>\n' +
                    '                    <div class="box-action">\n' +
                    '                        <a href="javascript:;" class="action-like"><i class="fas fa-thumbs-up"></i>Ëµû<em>0</em></a>\n' +
                    '                        <a href="javascript:;" class="action-reply click-no"><i class="fas fa-comment-alt"></i>ÂõûÂ§ç</a>\n' +
                    '                        <a href="javascript:;" class="action-delete"><i class="fas fa-trash-alt"></i>Âà†Èô§</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li>\n' +
                    '        </ol>')
                return $record;
            }
        })
    </script>
{% endblock %}