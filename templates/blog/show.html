{% extends 'base-blog.html' %}
{% load static %}
{% block title %}{{ article.title }}-å´”äº®çš„åšå®¢{% endblock %}
{% block link %}
    <link rel="stylesheet" href="{% static 'editormd/css/editormd.preview.css' %}"/>
    <script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
    <script src='{% static "editormd/lib/marked.min.js" %}'></script>
    <script src='{% static "editormd/lib/prettify.min.js" %}'></script>
    <script src='{% static "editormd/lib/raphael.min.js" %}'></script>
    <script src='{% static "editormd/lib/underscore.min.js" %}'></script>
    <script src='{% static "editormd/lib/sequence-diagram.min.js" %}'></script>
    <script src='{% static "editormd/lib/flowchart.min.js" %}'></script>
    <script src='{% static "editormd/lib/jquery.flowchart.min.js" %}'></script>
    <script src='{% static "editormd/editormd.js" %}'></script>
{% endblock %}
{% block content %}
    <main class="page-main">
        <div class="layui-row">
            <!--    é¡µé¢å·¦ä¾§ç•™ç©º-->
            <div class="layui-hide-xs layui-col-md2 left-null">
            </div>
            <!--    é¡µé¢ä¸»ä½“éƒ¨åˆ†-->
            <div class="layui-col-xs12 layui-col-md10 page-main-centre">
                <div class="layui-row main-centre">
                    <div class="layui-hide" id="content">
                    </div>
                    <!--            ä¸»ä½“ä¸­é—´æ­£æ–‡éƒ¨åˆ†-->
                    <div class="layui-col-md10 main-left">
                        <!--                    ä½ç½®ä¿¡æ¯-->
                        <blockquote class="layui-elem-quote location suspend">
                            <p>æ‚¨çš„ä½ç½®ï¼š <a href="/">é¦–é¡µ</a>
                                <i class="layui-icon layui-icon-next"></i>
                                <a href="/blog/category-{{ article.category.id }}">{{ article.category }}</a>
                                <i class="layui-icon layui-icon-next"></i>
                                <span>æ­£æ–‡</span></p>
                        </blockquote>
                        <!--            æ–‡ç« å†…å®¹-->
                        <div class="index-new">
                            <h1 class="article-title">{{ article.title }}</h1>
                            <div class="article-info">
                            <span>
                                <i class="fas fa-clock">{{ article.created_time }}</i>
                            </span>
                                <span>
                                <i class="fas fa-eye">{{ article.view }}</i>
                            </span>
                                <span>
                                <i class="fas fa-thumbs-up" id="like_action">{{ article.like }}</i>
                            </span>
                                <span>
                                <i class="fas fa-heart" id="collection_action">{{ article.collection }}</i>
                            </span>
                                <span>
                                <i class="fas fa-comment-dots" id="collection_action">{{ article.comment }}</i>
                            </span>
                            </div>
                            <div id='editormd-view' class="markdown-body">
                                <textarea style="display:none;">
{{ article.body }}
                                </textarea>
                            </div>
                            <div class="article-action">
                                <p>ç å­—ä¸æ˜“ï¼Œè½¬è½½è¯·æ³¨æ˜æœ¬æ–‡é“¾æ¥ï¼Œæ‚¨çš„æ‰“èµæ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒ!</p>
                                <div id="article-action">
                                    <a class="article-like" href="javascript:">
                                        <i class="layui-icon layui-icon-praise" id="like-text">ç‚¹èµ</i>
                                    </a>
                                    <a class="article-reward" href="javascript:">æ‰“èµ
                                        <div id="reward-box" class="reward-box-show">
                                            <h5>â¤ï¸æ‚¨å¯ä»¥é€‰æ‹©ä¸€ç§æ–¹å¼èµåŠ©æœ¬ç«™</h5>
                                            <img lay-src="{{ MEDIA_URL }}{{ img.pay }}">
                                        </div>
                                    </a>
                                    {% if articke_like == 0 %}
                                        <a class="article-collection" href="javascript:">
                                            <i class="layui-icon layui-icon-heart" id="collection-text">æ”¶è—</i>
                                            <div id="collection-box" class="layui-hide">
                                                <div class="collection-box-div">
                                                    æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç„¶åæ”¶è—æ–‡ç« 
                                                </div>
                                            </div>
                                        </a>
                                    {% else %}
                                        <a class="article-collection iscollection" href="javascript:">
                                            <i class="layui-icon layui-icon-heart" id="collection-text">å·²æ”¶è—</i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="article-relevance">
                                {% if last_article %}
                                    <a href="/blog/show-{{ last_article.pk }}" class="article-last">
                                        <i class="layui-icon layui-icon-left"></i>ä¸Šä¸€ç¯‡
                                        <br>
                                        {{ last_article }}
                                    </a>
                                {% else %}
                                    <a class="article-last">
                                        <i class="layui-icon layui-icon-left"></i>ä¸Šä¸€ç¯‡
                                        <br>
                                        æ²¡æœ‰äº†
                                    </a>
                                {% endif %}
                                <div>
                                    <p>æ–‡ç« åˆ†ç±»ï¼š<span class="label-tag label-color-0"><a
                                            href="/blog/category-{{ article.category.id }}">{{ article.category.name }}</a></span>
                                    </p>
                                    <p>æ–‡ç« æ ‡ç­¾ï¼š
                                        {% for tag in article.tags.all %}
                                            <span class="label-tag tag-color-{{ tag.id }}"><a
                                                    href="/blog/tag-{{ tag.id }}">{{ tag.name }}</a></span>
                                        {% endfor %}
                                    </p>
                                </div>
                                {% if next_article %}
                                    <a href="/blog/show-{{ next_article.pk }}" class="article-next">
                                        ä¸‹ä¸€ç¯‡<i class="layui-icon layui-icon-right"></i>
                                        <br>
                                        {{ next_article }}
                                    </a>
                                {% else %}
                                    <a class="article-next">
                                        ä¸‹ä¸€ç¯‡<i class="layui-icon layui-icon-right"></i>
                                        <br>
                                        æ²¡æœ‰äº†
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="index-new message-board">
                            <div class="message-editor">
                                <div class="message-title clearfix">
                                    <div><h1>ğŸ’– çŒœä½ å–œæ¬¢</h1></div>
                                </div>
                                <hr class="layui-bg-gray">
                                <div class="layui-row layui-col-space20">
                                    {% for like1 in guess1 %}
                                        <div class="layui-col-xs6 layui-col-md3 guess-like">
                                            <div>
                                                <a href=/blog/show-{{ like1.id }}>
                                                    <img src={{ MEDIA_URL }}{{ like1.img }}>
                                                    <p>{{ like1.title }}</p>
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% for like2 in guess2 %}
                                        <div class="layui-col-xs6 layui-col-md3 guess-like">
                                            <div>
                                                <a href=/blog/show-{{ like2.id }}>
                                                    <img src={{ MEDIA_URL }}{{ like2.img }}>
                                                    <p>{{ like2.title }}</p>
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="index-new message-board">
                            <div class="message-editor">
                                <div class="message-title clearfix">
                                    <div><h1>ğŸ“ æˆ‘è¦è¯„è®º</h1></div>
                                    <div>
                                        {% if count == 0 %}
                                            <em>æš‚æ— è¯„è®º</em>
                                        {% else %}
                                            <em>{{ count }}æ¡è¯„è®º</em>
                                        {% endif %}
                                    </div>
                                </div>
                                <hr class="layui-bg-gray">
                                <div class="layui-row message-body">
                                    <div class="layui-hide-xs layui-col-md1">
                                        <a>
                                            {% if userinfo.photo %}
                                                <img src="{{ MEDIA_URL }}{{ userinfo.photo }}"
                                                     class="layui-nav-img img-rotate">
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}{{ img.photo }}"
                                                     class="layui-nav-img img-rotate">
                                            {% endif %}
                                        </a>
                                    </div>
                                    <div class="layui-col-xs12 layui-col-md10">
                                        <textarea id="comment"></textarea>
                                    </div>
                                    <div class="layui-col-xs2 layui-col-md1">
                                        <button type="button" class="layui-btn layui-btn-normal">è¯„è®º</button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab">
                                <ul class="layui-tab-title">
                                    <li class="layui-this">å…¨éƒ¨è¯„è®º</li>
                                    <li>çƒ­é—¨è¯„è®º</li>
                                    <li>æˆ‘çš„è¯„è®º</li>
                                </ul>
                                <div class="layui-tab-content">
                                    {#                                    æœ€æ–°è¯„è®º#}
                                    <div class="layui-tab-item layui-show">
                                        {% if all_comment %}
                                            {% for ol in all_comment %}
                                                <ol class="list-body">
                                                    {% for li in ol %}
                                                        <li class="reply-{{ li.level }} message-content"
                                                            id="all-{{ li.id }}">
                                                            <a href={{ li.web }} target="_blank">
                                                                <img lay-src="{{ MEDIA_URL }}{{ li.photo }}"
                                                                     class="layui-nav-img img-rotate">
                                                            </a>
                                                            <div class="text-box">
                                                                <div class="box-info">
                                                                    {% if li.reply_name == 'None' %}
                                                                        <a href={{ li.web }} target="_blank">{{ li.username }}</a>
                                                                    {% else %}
                                                                        <a href={{ li.web }} target="_blank">{{ li.username }}</a>
                                                                        <em>å›å¤</em>
                                                                        <a href={{ li.reply_web }} target="_blank">{{ li.reply_name }}</a>
                                                                    {% endif %}
                                                                    <span class="timeago"
                                                                          datetime="{{ li.time }}"></span>
                                                                </div>
                                                                <div class="box-body">
                                                                    {{ li.content | safe }}
                                                                </div>
                                                                <div class="box-action">
                                                                    <a href="javascript:;" class="action-like"><i
                                                                            class="fas fa-thumbs-up"></i>èµ<em>{{ li.like }}</em></a>
                                                                    {% if li.username == user.username %}
                                                                        <a href="javascript:;"
                                                                           class="action-reply click-no"><i
                                                                                class="fas fa-comment-alt"></i>å›å¤</a>
                                                                    {% else %}
                                                                        <a href="javascript:;" class="action-reply"><i
                                                                                class="fas fa-comment-alt"></i>å›å¤</a>
                                                                    {% endif %}
                                                                    {% if li.username == user.username %}
                                                                        <a href="javascript:;"
                                                                           class="action-delete"><i
                                                                                class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                    {% else %}
                                                                        <a href="javascript:;"
                                                                           class="action-delete click-no"><i
                                                                                class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ol>
                                            {% endfor %}
                                        {% else %}
                                            <div class="comment-tips">
                                                <h3>æš‚æ— è¯„è®ºå“¦ï¼Œå¿«æ¥è¯„è®ºä¸€ä¸‹å§ï¼</h3>
                                            </div>
                                        {% endif %}

                                    </div>
                                    {#çƒ­é—¨è¯„è®º#}
                                    <div class="layui-tab-item">
                                        <ol class="list-body">
                                            {% if hot_comment %}
                                                {% for i in hot_comment %}
                                                    <li class="message-content" id="hot-{{ i.id }}">
                                                        <a href={{ i.user.userinfo.web }} target="_blank">
                                                            <img src="{{ MEDIA_URL }}{{ i.user.userinfo.photo }}"
                                                                 class="layui-nav-img img-rotate">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                <a href={{ i.user.userinfo.web }} target="_blank">{{ i.user.username }}</a>
                                                                <span class="timeago"
                                                                      datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ i.content | safe }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>èµ<em>{{ i.like }}</em></a>
                                                                <a href="javascript:;"
                                                                   class="action-reply click-no"><i
                                                                        class="fas fa-comment-alt"></i>å›å¤</a>
                                                                {% if i.user.username == user.username %}
                                                                    <a href="javascript:;" class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete click-no"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <div class="comment-tips">
                                                    <h3>æš‚æ— è¯„è®ºå“¦ï¼Œå¿«æ¥è¯„è®ºä¸€ä¸‹å§ï¼</h3>
                                                </div>
                                            {% endif %}
                                        </ol>
                                    </div>
                                    {#                                        æˆ‘çš„è¯„è®º#}
                                    <div class="layui-tab-item">
                                        {% if my_comment %}
                                            <ol class="list-body">
                                                {% for i in my_comment %}
                                                    <li class="message-content" id="my-{{ i.id }}">
                                                        <a href={{ i.user.userinfo.web }} target="_blank">
                                                            <img src="{{ MEDIA_URL }}{{ i.user.userinfo.photo }}"
                                                                 class="layui-nav-img img-rotate">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                <a href={{ i.user.userinfo.web }} target="_blank">{{ i.user.username }}</a>
                                                                <span class="timeago"
                                                                      datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ i.content |safe }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>èµ<em>{{ i.like }}</em></a>
                                                                <a href="javascript:;"
                                                                   class="action-reply click-no"><i
                                                                        class="fas fa-comment-alt"></i>å›å¤</a>
                                                                {% if i.user.username == user.username %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete click-no"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                                {% else %}
                                                <div class="comment-tips">
                                                    <h3>ğŸ¥ºæ‚¨è¿˜æ²¡æœ‰å‘è¡¨è¯„è®ºï¼Œå¿«æ¥è¯„è®ºå§ï¼</h3>
                                                </div>
                                            </ol>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {#        å›å¤è¯„è®ºå¼¹çª—#}
        <div id="reply-div">
            <textarea id="reply" style="display: none;"></textarea>
        </div>
        {#        å‘è¡¨è¯„è®ºå¼¹çª—#}
        <div id="collection-box" class="layui-hide">
            <div class="collection-box-div">
                æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç„¶åå‘è¡¨è¯„è®º
            </div>
        </div>
    </main>

{% endblock %}

{% block js %}
    <script>
        // è¯„è®ºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        layui.use(['layedit', 'layer', 'rate', 'flow', 'form'], function () {
            var layedit = layui.layedit;
            var $ = layui.jquery;
            var layer = layui.layer;
            var flow = layui.flow;
            var form = layui.form;
            var reply_textarea;
            //å½“ä½ æ‰§è¡Œè¿™æ ·ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå³å¯¹é¡µé¢ä¸­çš„å…¨éƒ¨å¸¦æœ‰lay-srcçš„imgå…ƒç´ å¼€å¯äº†æ‡’åŠ è½½ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŒ‡å®šç›¸å…³imgï¼‰
            flow.lazyimg();
            // markdownæ­£æ–‡æ˜¾ç¤º
            editormd.markdownToHTML("editormd-view", {
                htmlDecode: "style, script, iframe",
                emoji: true,
                taskList: true,
                tex: true,
                flowChart: true,
                sequenceDiagram: true,
            });
            // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            form.render(); //æ›´æ–°å…¨éƒ¨
            // å›¾ç‰‡æ¥å£æ”¾åˆ°å»ºç«‹ç¼–è¾‘å™¨å‰é¢ï¼Œå¦åˆ™æ— æ•ˆ
            layedit.set({
                uploadImage: {
                    url: '{% url "account:commentUpload" %}', //æ¥å£url
                    type: 'post', //é»˜è®¤post
                }
            });
            // è®¾ç½®å‘è¡¨è¯„è®ºç¼–è¾‘å™¨
            var index = layedit.build('comment', {
                height: 150 //è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
                , tool: ['face', 'image', '|', 'link', 'unlink']
            });
            // å»ºç«‹å‘è¡¨è¯„è®ºç¼–è¾‘å™¨
            form.verify({ // è¿™é‡Œå°±æ˜¯æŠŠå¯Œæ–‡æœ¬æ•°æ®åŒæ­¥åˆ°<textarea>ä¸­
                content: function (value) {
                    return layedit.sync(index);
                }
            });
            // å‘è¡¨è¯„è®ºæŒ‰é’®äº‹ä»¶
            $(".message-body button").click(function () {
                var $content = layedit.getContent(index)
                if ('{{ user.id }}' == 'None') {
                    layer.open({
                        type: 1,
                        title: 'å‘è¡¨è¯„è®º',
                        shadeClose: true,
                        content: $('#collection-box').html(),
                        btn: ['ç™»å½•'],
                        btnAlign: 'c',
                        yes: function (index) {
                            window.location.href = "{% url 'account:loginRegister' %}?next=" + window.location.pathname
                            layer.close(index);
                        }
                    })
                    return false;
                }
                if ($content.length == 0) {
                    layer.msg('äº²~è¯·å…ˆè¾“å…¥å†…å®¹ï¼Œç„¶åå†æäº¤å“¦ï¼', {icon: 5});
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: "{% url 'blog:postComment' %}",
                    data: {
                        article_id: "{{ article.id }}",
                        content: layedit.getContent(index),
                        username: "{{ user.username }}",
                        level: 0,
                        type: 'blog'
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            // æ–‡æœ¬åŸŸå†…å®¹éç©ºï¼Œåˆ›å»ºèŠ‚ç‚¹
                            var $record = createEle($content);
                            $(".layui-tab-item").prepend($record);
                            var timeago = layui.timeago;
                            timeago.render($('.timeago'));
                            layer.msg(result.msg, {icon: 6});
                            layui.layedit.clearContent(index);
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // è¯„è®ºç‚¹èµ
            $("body").delegate(".action-like", "click", function () {
                var num = $(this).find("em").text();
                var $like_click = $(this);
                var like_id = $like_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                $.ajax({
                    type: "GET",
                    url: "{% url 'blog:likeComment' %}",
                    data: {
                        like_id: like_id,
                        type: 'blog'
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            $like_click.find("em").html(parseInt(num) + 1);
                            $like_click.addClass("click-no");
                            layer.msg(result.msg, {icon: 6});
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // è¯„è®ºåˆ é™¤
            $("body").delegate(".action-delete", "click", function () {
                var $del_click = $(this)
                var del_id = $del_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                var del_level = $del_click.parents(".message-content").attr("class").replace(/[^\d]/g, '')
                var reply_count = $del_click.parents(".list-body").find("li").length
                layer.msg('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå†…å®¹å—ï¼Ÿ', {
                    time: 10000, //10såè‡ªåŠ¨å…³é—­
                    btnAlign: 'c',
                    btn: ['ç¡®å®š', 'å–æ¶ˆ'],
                    yes: function (index) {
                        layer.close(index);
                        $.ajax({
                            type: "GET",
                            url: "{% url 'blog:delComment' %}",
                            data: {
                                del_id: del_id,
                                type: 'blog'
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    if (del_level == 0 && reply_count == 1) {
                                        $del_click.parents(".message-content").remove();
                                    } else {
                                        $del_click.parents(".text-box").find(".box-body").html("è¯¥å†…å®¹å·²è¢«ç”¨æˆ·åˆ é™¤");
                                    }
                                    layer.msg(result.msg, {icon: 6});
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    },
                });
            })
            // è¯„è®ºå›å¤
            $("body").delegate(".action-reply", "click", function () {
                $reply_click = $(this);
                layer.open({
                    type: 1
                    , title: 'å›å¤è¯„è®º'
                    , area: ['400px', '300px']
                    , offset: 'auto'
                    , content: $('#reply-div').html()
                    , btn: ['å‘è¡¨å›å¤', 'å–æ¶ˆå›å¤']
                    , btnAlign: 'c'
                    , yes: function () {
                        $content = layedit.getContent(reply_textarea);
                        if ($content.length == 0) {
                            layer.msg('äº²~è¯·å…ˆè¾“å…¥å†…å®¹ï¼Œç„¶åå†æäº¤å“¦ï¼', {icon: 5});
                            return false;
                        }
                        var reply_level = parseInt($reply_click.parents(".message-content").attr("class").replace(/[^\d]/g, '')) + 1
                        var reply_id = $reply_click.parents(".message-content").attr("id").replace(/[^\d]/g, '')
                        var root_id = $reply_click.parents(".list-body").find("li").eq(0).attr("id").replace(/[^\d]/g, '')
                        $.ajax({
                            type: "POST",
                            url: "{% url 'blog:postComment' %}",
                            data: {
                                article_id: "{{ article.id }}",
                                content: layedit.getContent(reply_textarea),
                                username: "{{ user.username }}",
                                level: reply_level,
                                reply_id: reply_id,
                                root_id: root_id,
                                type: 'blog'
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    // æ–‡æœ¬åŸŸå†…å®¹éç©ºï¼Œåˆ›å»ºèŠ‚ç‚¹
                                    var $record = createReplyEle($content, reply_id, reply_level);
                                    var insert_id = "#all-" + reply_id
                                    $(insert_id).after($record);
                                    var timeago = layui.timeago;
                                    timeago.render($('.timeago'));
                                    layer.msg(result.msg, {icon: 6});
                                    layui.layedit.clearContent(index);
                                    layer.closeAll();
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    }
                    , btn2: function (index) {
                        layer.close(index);
                    },
                    success: function (layero, index) {
                        // è®¾ç½®å‘è¡¨è¯„è®ºç¼–è¾‘å™¨
                        reply_textarea = layedit.build($(layero).find('#reply'), {
                            height: 150 //è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
                            , tool: ['face', 'image', '|', 'link', 'unlink']
                        });
                        // æŠŠå¯Œæ–‡æœ¬æ•°æ®åŒæ­¥åˆ°<textarea>ä¸­
                        form.verify({
                            content: function (value) {
                                return layedit.sync(reply_textarea);
                            }
                        });
                    },
                });
            })

            // æ ¹æ®å†…å®¹åˆ›å»ºè¯„è®ºèŠ‚ç‚¹
            function createEle(content) {
                var $record = $('<ol class="list-body">\n' +
                    '            <li class="message-content">\n' +
                    '                <a href="#">\n' +
                    '                    <img src="{{ MEDIA_URL }}{{ userinfo.photo }}" class="layui-nav-img img-rotate">\n' +
                    '                </a>\n' +
                    '                <div class="text-box">\n' +
                    '                    <div class="box-info">\n' +
                    '                        <a href="#">{{ user.username }}</a>\n' +
                    '                        <span class="timeago" datetime="{% now "Y-m-d H:i:s" %}"></span>\n' +
                    '                    </div>\n' +
                    '                    <div class="box-body">\n' + content +
                    '                    </div>\n' +
                    '                    <div class="box-action">\n' +
                    '                        <a href="javascript:;" class="action-like"><i class="fas fa-thumbs-up"></i>èµ<em>0</em></a>\n' +
                    '                        <a href="javascript:;" class="action-reply"><i class="fas fa-comment-alt"></i>å›å¤</a>\n' +
                    '                        <a href="javascript:;" class="action-delete"><i class="fas fa-trash-alt"></i>åˆ é™¤</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li>\n' +
                    '        </ol>')
                return $record;
            }

            // æ ¹æ®å†…å®¹åˆ›å»ºè¯„è®ºå›å¤èŠ‚ç‚¹
            function createReplyEle(content, reply_id, reply_level) {
                var $record = $('<ol class="list-body">\n' +
                    '            <li class="reply-' + reply_level + ' message-content" id="all-' + reply_id + '">\n' +
                    '                <a href="#">\n' +
                    '                    <img src="{{ MEDIA_URL }}{{ userinfo.photo }}" class="layui-nav-img img-rotate">\n' +
                    '                </a>\n' +
                    '                <div class="text-box">\n' +
                    '                    <div class="box-info">\n' +
                    '                        <a href="#">{{ user.username }}</a>\n' +
                    '                        <span class="timeago" datetime="{% now "Y-m-d H:i:s" %}"></span>\n' +
                    '                    </div>\n' +
                    '                    <div class="box-body">\n' + content +
                    '                    </div>\n' +
                    '                    <div class="box-action">\n' +
                    '                        <a href="javascript:;" class="action-like"><i class="fas fa-thumbs-up"></i>èµ<em>0</em></a>\n' +
                    '                        <a href="javascript:;" class="action-reply click-no"><i class="fas fa-comment-alt"></i>å›å¤</a>\n' +
                    '                        <a href="javascript:;" class="action-delete"><i class="fas fa-trash-alt"></i>åˆ é™¤</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li>\n' +
                    '        </ol>')
                return $record;
            }

            // ç‚¹èµ
            $("#article-action>a").eq(0).click(function () {
                $(this).animate({
                    width: '45%'
                }, 500, function () {
                    $.ajax({
                        type: "GET",
                        url: "{% url 'blog:articleLike' %}",
                        data: {
                            type: "blog",
                            article_id: "{{ article.id }}"
                        },
                        success: function (result) {
                            if (result.code == 1) {
                                $("#article-action>a").eq(0).css({'background': '#3498db', 'pointer-events': 'none'});
                                $("#article-action>a").eq(0).find("i").text("å·²ç‚¹èµ")
                                var like_num = parseInt($("#like_action").text()) + 1
                                $("#like_action").text(like_num)
                                layer.msg(result.msg, {icon: 6});
                            } else {
                                layer.alert(result.msg, {icon: 2});
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                })
            })
            // æ‰“èµ
            $("#article-action>a").eq(1).hover(function () {
                $("#reward-box").stop().stop().slideToggle(500)
            })
            // æ·»åŠ æ”¶è—
            $('#article-action .article-collection').click(function () {
                var $like = $(this)
                if ('{{ user.username }}') {
                    if ($like.find("i").text() == 'å·²æ”¶è—') {
                        $.ajax({
                            type: "GET",
                            url: "{% url 'blog:deleteCollection' %}",
                            data: {
                                article_id: "{{ article.id }}",
                                type: "blog"
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    $(".article-collection").removeClass("iscollection")
                                    $(".article-collection").find('i').text("æ”¶è—")
                                    var like_num = parseInt($("#collection_action").text()) - 1
                                    $("#collection_action").text(like_num)
                                    layer.msg(result.msg, {icon: 6});
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    } else {
                        $.ajax({
                            type: "GET",
                            url: "{% url 'blog:articleCollection' %}",
                            data: {
                                article_id: "{{ article.id }}",
                                type: "blog"
                            },
                            success: function (result) {
                                if (result.code == 1) {
                                    $(".article-collection").addClass("iscollection")
                                    $(".article-collection").find('i').text("å·²æ”¶è—")
                                    var like_num = parseInt($("#collection_action").text()) + 1
                                    $("#collection_action").text(like_num)
                                    layer.msg(result.msg, {icon: 6});
                                } else {
                                    layer.alert(result.msg, {icon: 2});
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    }
                } else {
                    layer.open({
                        type: 1,
                        title: 'æ·»åŠ æ”¶è—',
                        shadeClose: true,
                        content: $('#collection-box').html(),
                        btn: ['ç™»å½•'],
                        btnAlign: 'c',
                        yes: function (index) {
                            window.location.href = "{% url 'account:loginRegister' %}?next=" + window.location.pathname
                            layer.close(index);
                        }
                    })
                }
            });
            // ç›®å½•
            w = $(window).width(); //æµè§ˆå™¨å½“å‰çª—å£å¯è§†åŒºåŸŸå®½åº¦
            if (w > 768) {
                openContent()
            }

            function openContent() {
                if ($('.markdown-toc-list').length == 0) {
                    return false;
                }
                layer.ready(function () {
                    setTimeout(function () {
                        layer.open({
                            id: 'catalogue'
                            , type: 1
                            , title: ['ğŸ“‹ç›®å½•', 'font-size:24px;color:#1e9fff']
                            , area: '230px'
                            , maxWidth: '500'
                            , maxHeight: '650'
                            , maxmin: true
                            , shade: 0
                            , anim: 5
                            , offset: ['80px', '15px']
                            , content: $('.markdown-toc-list').html()
                            , success: function (layero) {
                                layer.setTop(layero); //é‡ç‚¹2
                            }
                        });
                    }, 1000)
                });
            }

            // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§
            $('#editormd-view img').on('click', function () {
                layer.photos({
                    photos: '#editormd-view',
                    closeBtn: 2,
                    anim: 0
                });
            })
            // æ¨èé˜…è¯»å½“å‰é«˜äº®
            $(function () {
                $(".guess-like").hover(function () {
                    console.log("qaaa")
                    $(this).siblings().stop().fadeTo(100, 0.6);
                }, function () {
                    $(this).siblings().stop().fadeTo(100, 1);
                })
            })
            // å›¾ç‰‡å–æ¶ˆé˜²ç›—é“¾
            $("#editormd-view img").each(function () {
                old_src = $(this).attr('src')
                new_src = 'https://images.weserv.nl/?url=' + old_src
                $(this).attr("src", new_src);
            })
            // å¯¼èˆªæ å½“å‰æ ‡ç­¾é¡µ
        $(".nav2").addClass("layui-this");
        var category_id = "#category-" + {{ article.category.id }}
            console.log(category_id)
            $(category_id).addClass("layui-this")
        var m_category_id = "#m-category-" + {{ article.category.id }}
            $(m_category_id).addClass("layui-this")
        $(m_category_id).parents("li").addClass("layui-nav-itemed")
        });
    </script>
{% endblock %}